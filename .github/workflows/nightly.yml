name: Nightly Integration Tests

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger
  pull_request:
    branches:
      - main

jobs:
  nightly-tests:
    name: Nightly Integration Tests with Real Docs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'

      - name: Build tool
        run: go build -o ocp-doc-checker .

      - name: Run Go unit tests
        run: go test -v ./...

      - name: Run comprehensive integration test suite
        run: ./test.sh

      - name: Run anchor validation tests (detailed)
        run: ./scripts/test-anchor-validation.sh

      - name: Test batch mode
        run: |
          echo "Testing batch mode with multiple URLs..."
          mkdir -p test-docs
          cat > test-docs/test.md << 'EOF'
          # Test Document
          
          Some links:
          - https://docs.redhat.com/en/documentation/openshift_container_platform/4.17/html-single/networking/index#installing-sr-iov-operator_installing-sriov-operator
          - https://docs.redhat.com/en/documentation/openshift_container_platform/4.17/html-single/disconnected_environments/index#mirroring-image-set-full
          - https://docs.redhat.com/en/documentation/openshift_container_platform/4.15/html-single/authentication_and_authorization/index
          EOF
          
          # Run batch mode - exit code 1 means outdated docs found, which is expected
          ./ocp-doc-checker -dir test-docs -verbose || EXIT_CODE=$?
          if [ "${EXIT_CODE:-0}" -eq 1 ]; then
            echo "✓ Found outdated docs (expected behavior)"
            exit 0
          elif [ "${EXIT_CODE:-0}" -eq 0 ]; then
            echo "✓ All docs up to date"
            exit 0
          else
            echo "✗ Unexpected exit code: $EXIT_CODE"
            exit 1
          fi

      - name: Test outdated URL detection
        run: ./scripts/test-outdated-url.sh
        continue-on-error: false

      - name: Test current URL validation
        run: ./scripts/test-current-url.sh
        continue-on-error: false

      - name: Test URL accessibility
        run: ./scripts/test-url-accessibility.sh
        continue-on-error: true  # Network tests may be flaky

      - name: Test invalid URL handling
        run: ./scripts/test-invalid-url.sh
        continue-on-error: false

      - name: Test URL replacement
        run: ./scripts/test-url-replacement.sh
        continue-on-error: false

      - name: Create summary report
        if: always()
        run: |
          echo "## Nightly Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ran comprehensive integration tests against real Red Hat documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tests Executed:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Go unit tests" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Full integration test suite (test.sh)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Anchor validation with real URLs" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Batch mode testing" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Outdated URL detection" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Current URL validation" >> $GITHUB_STEP_SUMMARY
          echo "- ⚠️  URL accessibility (may be skipped due to network flakiness)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Invalid URL handling" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ URL replacement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Note: Exit codes 0 (up-to-date) and 1 (outdated) are both valid responses from the tool._" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Nightly integration tests failed! Check the logs for details."

